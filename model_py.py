# -*- coding: utf-8 -*-
"""model.py

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1toEHsRkzDnHacBwZhgl2bwKK96CUByLB
"""

import torch
import torch.nn as nn
import torchvision.transforms.functional as tf

class doubleconv(nn.Module): #밑의 그림에서 3개의 tensor 가 가공되는과정 화살표 2개 의미
  def __init__(self,inchannels,outchannels):
    super(doubleconv,self).__init__() #nn.module 불러옴
    self.conv = nn.Sequential( #layer의 집합
        nn.Conv2d(inchannels,outchannels,3,1,1), #kernal,stride,padding
        nn.BatchNorm2d(outchannels), #std,var 정규화
        nn.ReLU(inplace=True), # activation
        nn.Conv2d(outchannels,outchannels,3,1,1),
        nn.Batchnorm2d(outchannels),
        nn.ReLU(inplace=True)
        )  #생성자

  def forward(self,x): #forward pass
    return self.conv(x)

class unet(nn.Module):
  def __init__(
      self,inchannels=3,outchannels=1,
      features =[64,128,256,512]
  ):
    super(unet,self).__init__()
    self.ups = nn.Modulelist() #화살표 위로 가는 과정 upsampling
    self.downs = nn.Modulelist() #화살표 밑으로 과정 downsampling
    self.pool = nn.MaxPool2d(kernal_size=2,stride=2) #밑으로 내려가는 화살표

    for feature in features:  #inchannels = 3
      self.downs.append(doubleconv(inchannels,feature))
       #밑으로 순차적으로 가면서 일련의 모든 conv layer list에 추가
      inchannels = feature # inchannel 값 update 시킴으로써 feature 와 상호작용
    #위의 과정 거꾸로
    for feature in reversed(features):
      self.ups.append(
          nn.ConvTranspose2d(feature*2,feature,kernel_size=2,stride=2)
          # inchannel 안바꿔도 되는이유 outchannel이 정확히 1/2배 됨으로 feature*2,feature
          )
      self.ups.append(doubleconv(feature*2,feature))
    #맨밑의 512->1024 부분
    self.bottleneck = doubleconv(features[-1],features[-1]*2)
    #맨위의 output segmentation 부분
    self.final_conv = nn.Conv2d(features[0],outchannels,kernel_size=1)
    # forward pass를 위한 모든 생성자 형성
  def forward(self,x):
    skip_connections = [] #잔차 연결 resnet에서 한 번 다룸
    for down in self.downs:
      x= down(x)
      skip_connections.append(x) #doublecov 통과할때마다 그값을 upsampling값에 추가
      x=self.pool(x)

    x = self.bottleneck(x)
    skip_connections = skip_connections[::-1] #residual 에서 concat하기 위한 사전조치

    for idx in range(0,len(self.ups),2):
      x = self.ups[idx](x)
      skip_connection = skip_connections[idx//2]

      if x.shape != skip_connection.shape:
        x = tf.resize(x,size= skip_connection.shape[2:])

      concat_skip = torch.cat((skip_connection,x),dim=1)
      x= self.ups[idx+1](concat_skip)
    return self.final_conv(x)



"""![unet.png](data:image/png;base64,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)"""

